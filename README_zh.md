# 具备长期记忆的 LLM 工具调用智能体

[Read this document in English](README.md)

本项目提供了一个先进的框架，用于构建能够使用工具并拥有持久化长时记忆的 AI 智能体。它通过实现一个复杂的混合记忆架构，克服了标准有限上下文窗口的局限，使智能体能够记住过去的对话、学习事实，并检索相关上下文以做出决策。

整个系统使用 Python 的 `asyncio` 构建，以高效处理 API 调用和数据库交互等 I/O 密集型操作，确保了流畅的响应式用户体验。

## 核心概念：混合记忆

标准的 LLM 是无状态的。本引擎通过集成两个强大的记忆组件来解决这个问题，这两个组件会在智能体的每次行动前被自动查询：

1.  **知识图谱 (Neo4j):** 用于存储**结构化的、事实性的记忆**。系统会自动从对话中提取关键实体及其关系（例如，“小明就职于 Acme 公司”）并将其存储为图。这允许进行精确的、基于事实的查询。
2.  **向量存储 (Milvus):** 用于存储**语义化的、情景性的记忆**。它将对话回合存储为向量嵌入。这使得系统能够根据对话的含义和上下文找到相关的过往互动，即使措辞不同。

通过结合这两种记忆，系统能自动构建一个丰富而全面的上下文，为智能体的每一个决策提供信息支持。

## 功能特性

-   **持久化长时记忆**: 智能体能够在多个会话之间记住信息。
-   **自动化上下文增强**: 在每一轮对话之前，智能体的上下文都会自动从其知识图谱和向量存储中检索相关事实和过往对话，从而得到增强。
-   **可扩展的工具调用框架**: 轻松定义和添加新工具，让智能体能够执行外部操作（例如，获取实时数据、调用 API）。
-   **异步记忆处理**: 记忆更新（关系抽取、向量嵌入）作为后台任务运行，确保智能体在不阻塞的情况下能立即准备好接收用户的下一个输入。
-   **自动对话摘要**: 为防止上下文窗口溢出，系统会自动总结长对话。
-   **基于 Docker 的数据库设置**: 包含一个简单的单行命令，用于设置带有所有必要插件的持久化 Neo4j 数据库。

## 架构概览

系统作为一个复杂的智能体循环进行操作：

1.  **用户输入**: 用户提供一个提示。
2.  **自动记忆检索**: `ContextManager` 自动查询 Neo4j 图和 Milvus 向量存储，以查找与用户查询相关的背景信息。
3.  **LLM 决定行动**: 用户的查询、对话历史以及检索到的背景信息被发送给 LLM。LLM 决定是直接回答还是使用工具。
4.  **工具执行 (如果需要)**: 如果 LLM 决定使用工具，系统将执行相应的 Python 函数并将结果返回给 LLM。
5.  **最终响应**: LLM 使用工具的输出（或其初始推理）来生成面向用户的最终答案。
6.  **异步记忆更新**: 整个对话回合（用户查询、工具调用、最终答案）在后台进行处理，以提取新知识并将其存储在长时记忆中以备将来使用。主循环不会等待此过程完成。

## 技术栈

-   **核心**: Python 3.9+, asyncio
-   **LLM & 嵌入**: 任何与 OpenAI 兼容的 API
-   **知识图谱**: Neo4j
-   **向量存储**: Milvus Lite (本地文件数据库)
-   **容器化**: Docker

## 安装与设置

### 第 1 步：环境要求

-   Python 3.9+
-   Docker

### 第 2 步：克隆仓库并设置环境

```bash
# 克隆本仓库
git clone https://github.com/your-username/llm-memory-manager.git
cd llm-memory-manager

# 创建并激活一个虚拟环境 (推荐)
python -m venv venv
source venv/bin/activate  # 在 Windows 上, 使用 `venv\Scripts\activate`

# 安装 Python 依赖
pip install -r requirements.txt
```

### 第 3 步：启动 Neo4j 数据库

在您的终端中运行以下命令，以启动一个包含所需 APOC 插件的 Neo4j 容器。此命令还会确保您的数据在重启后依然存在。

```bash
# 请务必将 'your_strong_password_here' 替换为一个安全的密码
docker run -d --name llm-memory-neo4j -p 7474:7474 -p 7687:7687 -v neo4j_data:/data --env NEO4J_AUTH="neo4j/your_strong_password_here" --env NEO4J_ACCEPT_LICENSE_AGREEMENT=yes --env NEO4J_PLUGINS='["apoc"]' neo4j:5.20.0-enterprise
```

### 第 4 步：配置应用程序

您的应用程序通过环境变量进行配置，这些变量从 `src/config.py` 中读取。对于生产环境，建议使用 `.env` 文件，但目前您可以直接编辑 `src/config.py` 中的默认值。

1.  **打开 `src/config.py`**。
2.  **设置您的 LLM 服务商凭证**: 更新 `OPENAI_API_KEY`, `OPENAI_BASE_URL`, `LLM_MODEL_NAME`, 和 `EMBEDDING_MODEL_NAME`。
3.  **设置您的 Neo4j 密码**: 更新 `NEO4J_PASSWORD` 的值，使其与您在第 3 步的 `docker run` 命令中设置的密码**完全匹配**。

## 如何运行

设置完成后，使用此命令启动交互式智能体：

```bash
python main.py
```

智能体现在已准备就绪。输入 `exit` 即可退出。

## 如何使用：交互示例

以下是一些如何与智能体互动的示例：

-   **使用工具**:
    > `Your question: 现在几点了?`

-   **向记忆中添加事实**:
    > `Your question: 我最喜欢的项目叫做'凤凰计划'。`

-   **从记忆中检索事实**:
    > `Your question: 我最喜欢的项目叫什么名字?`
